<!-- ===== templates/optimization/configure.html - Faculty/Department Selection ===== -->
{% extends "base.html" %}

{% block title %}Configure Optimization{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-magic me-2"></i>Configure Schedule Optimization
        </h1>
        <a href="{{ url_for('optimization.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>

    <form method="POST" id="optimizationForm">
        <div class="row">
            <!-- Main Configuration -->
            <div class="col-md-8">
                <!-- Step 1: Selection Type -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-list-ul me-2"></i>Step 1: Choose Optimization Scope
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card border" id="facultyOption">
                                    <div class="card-body text-center">
                                        <input type="radio" name="optimization_type" value="faculty" id="opt_faculty" class="form-check-input mb-2">
                                        <label for="opt_faculty" class="card-title h5 d-block">
                                            <i class="fas fa-university fa-2x text-primary mb-2 d-block"></i>
                                            Full Faculty
                                        </label>
                                        <p class="card-text small text-muted">
                                            Optimize entire faculty with all departments
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border" id="departmentsOption">
                                    <div class="card-body text-center">
                                        <input type="radio" name="optimization_type" value="departments" id="opt_departments" class="form-check-input mb-2">
                                        <label for="opt_departments" class="card-title h5 d-block">
                                            <i class="fas fa-check-square fa-2x text-success mb-2 d-block"></i>
                                            Select Departments
                                        </label>
                                        <p class="card-text small text-muted">
                                            Choose specific departments
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border" id="singleOption">
                                    <div class="card-body text-center">
                                        <input type="radio" name="optimization_type" value="single" id="opt_single" class="form-check-input mb-2">
                                        <label for="opt_single" class="card-title h5 d-block">
                                            <i class="fas fa-building fa-2x text-info mb-2 d-block"></i>
                                            Single Department
                                        </label>
                                        <p class="card-text small text-muted">
                                            Traditional single department
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Faculty/Department Selection -->
                <div class="card shadow mb-4" id="selectionCard" style="display: none;">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-check-square me-2"></i>Step 2: Select Faculty/Departments
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Faculty Selection (for full faculty mode) -->
                        <div id="facultySelectionDiv" style="display: none;">
                            <label for="faculty_id" class="form-label">Choose Faculty:</label>
                            <select class="form-select" id="faculty_id" name="faculty_id">
                                <option value="">Select Faculty</option>
                                {% for faculty in faculty_stats %}
                                    <option value="{{ faculty.faculty.id }}" 
                                            data-departments="{{ faculty.department_count }}"
                                            data-lessons="{{ faculty.lesson_count }}"
                                            data-instructors="{{ faculty.instructor_count }}">
                                        {{ faculty.faculty.name }} 
                                        ({{ faculty.department_count }} departments, {{ faculty.lesson_count }} lessons)
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="alert alert-info mt-3" id="facultyInfo" style="display: none;">
                                <strong>Selected Faculty will include:</strong>
                                <div id="facultyDetails"></div>
                            </div>
                        </div>

                        <!-- Department Selection (checkbox mode) -->
                        <div id="departmentSelectionDiv" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="selectAllDepts" class="form-check-input">
                                            </th>
                                            <th>Faculty</th>
                                            <th>Department</th>
                                            <th>Lessons</th>
                                            <th>Instructors</th>
                                            <th>Complexity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for faculty in faculty_stats %}
                                            {% set faculty_obj = faculty.faculty %}
                                            {% set departments = faculty_obj.departments|selectattr('is_active') %}
                                            
                                            {% for dept in departments %}
                                                {% set dept_lessons = dept.lessons|selectattr('is_active')|list|length %}
                                                {% set dept_instructors = dept.instructors|selectattr('is_active')|list|length %}
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" name="department_ids" value="{{ dept.id }}" 
                                                               class="form-check-input dept-checkbox"
                                                               data-faculty="{{ faculty_obj.id }}"
                                                               data-lessons="{{ dept_lessons }}"
                                                               data-instructors="{{ dept_instructors }}">
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-outline-primary">{{ faculty_obj.code }}</span>
                                                        <small class="d-block text-muted">{{ faculty_obj.name }}</small>
                                                    </td>
                                                    <td>
                                                        <strong>{{ dept.name }}</strong>
                                                        <small class="d-block text-muted">{{ dept.num_grades }} grades</small>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-primary">{{ dept_lessons }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-success">{{ dept_instructors }}</span>
                                                    </td>
                                                    <td>
                                                        {% if dept_lessons > 20 %}
                                                            <span class="badge badge-danger">High</span>
                                                        {% elif dept_lessons > 10 %}
                                                            <span class="badge badge-warning">Medium</span>
                                                        {% else %}
                                                            <span class="badge badge-success">Low</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3" id="selectionSummary" style="display: none;">
                                <h6><i class="fas fa-info-circle me-2"></i>Selection Summary</h6>
                                <div id="summaryContent"></div>
                            </div>
                        </div>

                        <!-- Single Department Selection -->
                        <div id="singleDepartmentDiv" style="display: none;">
                            <label for="department_id" class="form-label">Choose Department:</label>
                            <select class="form-select" id="department_id" name="department_id">
                                <option value="">Select Department</option>
                                {% for faculty in faculty_stats %}
                                    <optgroup label="{{ faculty.faculty.name }}">
                                        {% for dept in faculty.faculty.departments|selectattr('is_active') %}
                                            {% set dept_lessons = dept.lessons|selectattr('is_active')|list|length %}
                                            <option value="{{ dept.id }}">
                                                {{ dept.name }} ({{ dept_lessons }} lessons)
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Basic Parameters -->
                <div class="card shadow mb-4" id="parametersCard" style="display: none;">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-cog me-2"></i>Step 3: Basic Settings
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="semester" class="form-label">Semester *</label>
                                <select class="form-select" id="semester" name="semester" required>
                                    <option value="">Select Semester</option>
                                    <option value="1">Fall Semester (Güz)</option>
                                    <option value="2">Spring Semester (Bahar)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="academic_year" class="form-label">Academic Year</label>
                                <input type="text" class="form-control" id="academic_year" name="academic_year" 
                                       value="2024-2025" placeholder="2024-2025">
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="use_building_preference" 
                                   name="use_building_preference" value="1" checked>
                            <label class="form-check-label" for="use_building_preference">
                                Prefer classrooms in department's faculty building
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-md-4">
                <!-- Progress Indicator -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-success">Configuration Progress</h6>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <ul class="list-unstyled mb-0">
                            <li id="step1Status" class="mb-2">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span class="text-muted">Choose optimization type</span>
                            </li>
                            <li id="step2Status" class="mb-2">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span class="text-muted">Select departments</span>
                            </li>
                            <li id="step3Status" class="mb-2">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span class="text-muted">Set parameters</span>
                            </li>
                            <li id="step4Status">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span class="text-muted">Ready to optimize</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Selection Summary -->
                <div class="card shadow mb-4" id="summaryCard" style="display: none;">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-info">Optimization Summary</h6>
                    </div>
                    <div class="card-body">
                        <div id="optimizationSummary">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Algorithm Info -->
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-warning">Algorithm Features</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Conflict elimination priority
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Workload balancing
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Room utilization optimization
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Multi-department coordination
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Automatic parameter tuning
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('optimization.index') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" id="previewBtn" disabled>
                            <i class="fas fa-eye me-1"></i>Preview Configuration
                        </button>
                        <button type="submit" class="btn btn-success" id="startBtn" disabled>
                            <i class="fas fa-rocket me-1"></i>Start Optimization
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
$(document).ready(function() {
    let currentStep = 0;
    
    // Step 1: Optimization type selection
    $('input[name="optimization_type"]').change(function() {
        const selectedType = $(this).val();
        currentStep = 1;
        updateProgress();
        
        // Hide all selection divs first
        $('#facultySelectionDiv, #departmentSelectionDiv, #singleDepartmentDiv').hide();
        $('#selectionCard').show();
        
        // Show appropriate selection div
        if (selectedType === 'faculty') {
            $('#facultySelectionDiv').show();
        } else if (selectedType === 'departments') {
            $('#departmentSelectionDiv').show();
        } else if (selectedType === 'single') {
            $('#singleDepartmentDiv').show();
        }
        
        // Add visual selection to cards
        $('.card.border').removeClass('border-primary');
        $(this).closest('.card').addClass('border-primary');
    });
    
    // Faculty selection
    $('#faculty_id').change(function() {
        const selected = $(this).find(':selected');
        if (selected.val()) {
            const departments = selected.data('departments');
            const lessons = selected.data('lessons');
            const instructors = selected.data('instructors');
            
            $('#facultyDetails').html(`
                <div class="row text-center">
                    <div class="col-4">
                        <strong>${departments}</strong><br>
                        <small>Departments</small>
                    </div>
                    <div class="col-4">
                        <strong>${lessons}</strong><br>
                        <small>Lessons</small>
                    </div>
                    <div class="col-4">
                        <strong>${instructors}</strong><br>
                        <small>Instructors</small>
                    </div>
                </div>
            `);
            $('#facultyInfo').show();
            currentStep = 2;
            updateProgress();
            showParametersCard();
        } else {
            $('#facultyInfo').hide();
        }
    });
    
    // Department checkbox selection
    $('.dept-checkbox').change(function() {
        updateDepartmentSelection();
    });
    
    // Select all departments checkbox
    $('#selectAllDepts').change(function() {
        $('.dept-checkbox').prop('checked', $(this).prop('checked'));
        updateDepartmentSelection();
    });
    
    // Single department selection
    $('#department_id').change(function() {
        if ($(this).val()) {
            currentStep = 2;
            updateProgress();
            showParametersCard();
        }
    });
    
    // Semester selection
    $('#semester').change(function() {
        if ($(this).val()) {
            currentStep = 3;
            updateProgress();
            updateSummaryCard();
            $('#startBtn, #previewBtn').prop('disabled', false);
        }
    });
    
    // Form submission
    $('#optimizationForm').submit(function(e) {
        const submitBtn = $('#startBtn');
        submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>Starting...');
        submitBtn.prop('disabled', true);
    });
    
    // Preview configuration
    $('#previewBtn').click(function() {
        // Show configuration preview modal or alert
        alert('Preview functionality will show detailed configuration summary');
    });
    
    function updateDepartmentSelection() {
        const checked = $('.dept-checkbox:checked');
        
        if (checked.length > 0) {
            currentStep = 2;
            updateProgress();
            showParametersCard();
            
            let totalLessons = 0;
            let totalInstructors = 0;
            const faculties = new Set();
            
            checked.each(function() {
                totalLessons += parseInt($(this).data('lessons'));
                totalInstructors += parseInt($(this).data('instructors'));
                faculties.add($(this).data('faculty'));
            });
            
            $('#summaryContent').html(`
                <strong>Selected:</strong> ${checked.length} departments from ${faculties.size} faculty/faculties<br>
                <strong>Total:</strong> ${totalLessons} lessons, ${totalInstructors} instructors<br>
                <strong>Complexity:</strong> ${totalLessons > 50 ? 'High' : totalLessons > 20 ? 'Medium' : 'Low'}
            `);
            $('#selectionSummary').show();
        } else {
            $('#selectionSummary').hide();
            $('#parametersCard').hide();
        }
    }
    
    function showParametersCard() {
        $('#parametersCard').show();
    }
    
    function updateProgress() {
        const progress = (currentStep / 3) * 100;
        $('#progressBar').css('width', progress + '%');
        
        // Update step indicators
        for (let i = 1; i <= 4; i++) {
            const stepEl = $(`#step${i}Status`);
            const icon = stepEl.find('i');
            const text = stepEl.find('span');
            
            if (i <= currentStep) {
                icon.removeClass('fa-circle text-muted').addClass('fa-check-circle text-success');
                text.removeClass('text-muted').addClass('text-success');
            } else if (i === currentStep + 1) {
                icon.removeClass('fa-circle text-muted fa-check-circle text-success').addClass('fa-circle text-warning');
                text.removeClass('text-muted text-success').addClass('text-warning');
            }
        }
    }
    
    function updateSummaryCard() {
        const optimizationType = $('input[name="optimization_type"]:checked').val();
        let summaryHtml = '';
        
        if (optimizationType === 'faculty') {
            const faculty = $('#faculty_id option:selected').text();
            summaryHtml = `
                <h6><i class="fas fa-university me-2"></i>Full Faculty Optimization</h6>
                <p class="mb-1"><strong>Faculty:</strong> ${faculty}</p>
            `;
        } else if (optimizationType === 'departments') {
            const deptCount = $('.dept-checkbox:checked').length;
            summaryHtml = `
                <h6><i class="fas fa-check-square me-2"></i>Multi-Department Optimization</h6>
                <p class="mb-1"><strong>Departments:</strong> ${deptCount} selected</p>
            `;
        } else if (optimizationType === 'single') {
            const dept = $('#department_id option:selected').text();
            summaryHtml = `
                <h6><i class="fas fa-building me-2"></i>Single Department</h6>
                <p class="mb-1"><strong>Department:</strong> ${dept}</p>
            `;
        }
        
        const semester = $('#semester option:selected').text();
        const year = $('#academic_year').val();
        
        summaryHtml += `
            <p class="mb-1"><strong>Semester:</strong> ${semester}</p>
            <p class="mb-0"><strong>Academic Year:</strong> ${year}</p>
        `;
        
        $('#optimizationSummary').html(summaryHtml);
        $('#summaryCard').show();
    }
});
</script>

<style>
.card.border-primary {
    border-width: 2px !important;
}

.card-body .form-check-input {
    cursor: pointer;
}

.card-body .form-check-label {
    cursor: pointer;
}

.progress-bar {
    transition: width 0.3s ease;
}

.table th:first-child {
    text-align: center;
}

.table td:first-child {
    text-align: center;
}
</style>
{% endblock %}