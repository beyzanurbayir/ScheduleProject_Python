<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}Dashboard - Schedule Optimizer{% endblock %}

{% block content %}
<div class="col-12">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            <small class="text-muted">University Schedule Management System</small>
        </h1>
        <div class="btn-group">
            <a href="{{ url_for('optimization.configure') }}" class="btn btn-success">
                <i class="fas fa-rocket me-2"></i>Start Optimization
            </a>
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-plus me-2"></i>Quick Add
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('data_entry.create_department') }}">
                    <i class="fas fa-building me-2"></i>Department
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('data_entry.create_lesson') }}">
                    <i class="fas fa-book me-2"></i>Lesson
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('data_entry.create_instructor') }}">
                    <i class="fas fa-user-plus me-2"></i>Instructor
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('data_entry.create_classroom') }}">
                    <i class="fas fa-door-open me-2"></i>Classroom
                </a></li>
            </ul>
        </div>
    </div>

    <!-- Enhanced Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card card-stat bg-primary text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-0" data-stat="departments_count">{{ departments_count|default(0) }}</h3>
                        <p class="card-text mb-0">Departments</p>
                        <small class="opacity-75">Academic units</small>
                    </div>
                    <div class="fs-2">
                        <i class="fas fa-building"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-stat bg-success text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-0" data-stat="lessons_count">{{ lessons_count|default(0) }}</h3>
                        <p class="card-text mb-0">Lessons</p>
                        <small class="opacity-75">Active courses</small>
                    </div>
                    <div class="fs-2">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-stat bg-info text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-0" data-stat="instructors_count">{{ instructors_count|default(0) }}</h3>
                        <p class="card-text mb-0">Instructors</p>
                        <small class="opacity-75">Teaching staff</small>
                    </div>
                    <div class="fs-2">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-stat bg-warning text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-0" data-stat="classrooms_count">{{ classrooms_count|default(0) }}</h3>
                        <p class="card-text mb-0">Classrooms</p>
                        <small class="opacity-75">Learning spaces</small>
                    </div>
                    <div class="fs-2">
                        <i class="fas fa-door-open"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-stat bg-secondary text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-0" data-stat="active_optimizations">{{ active_optimizations|default(0) }}</h3>
                        <p class="card-text mb-0">Active Runs</p>
                        <small class="opacity-75">In progress</small>
                    </div>
                    <div class="fs-2">
                        <i class="fas fa-cogs"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-stat bg-dark text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-0" data-stat="total_capacity">{{ total_capacity|default(0) }}</h3>
                        <p class="card-text mb-0">Total Capacity</p>
                        <small class="opacity-75">Student seats</small>
                    </div>
                    <div class="fs-2">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quick Actions -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2 text-primary"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <a href="{{ url_for('data_entry.create_department') }}" class="btn btn-outline-primary w-100 py-3">
                                <i class="fas fa-building d-block fs-4 mb-2"></i>
                                Add Department
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('data_entry.create_lesson') }}" class="btn btn-outline-success w-100 py-3">
                                <i class="fas fa-book d-block fs-4 mb-2"></i>
                                Add Lesson
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('data_entry.create_instructor') }}" class="btn btn-outline-info w-100 py-3">
                                <i class="fas fa-user-plus d-block fs-4 mb-2"></i>
                                Add Instructor
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('data_entry.create_classroom') }}" class="btn btn-outline-warning w-100 py-3">
                                <i class="fas fa-door-open d-block fs-4 mb-2"></i>
                                Add Classroom
                            </a>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="d-grid">
                        <a href="{{ url_for('optimization.configure') }}" class="btn btn-success btn-lg py-3">
                            <i class="fas fa-rocket me-2"></i>Start New Optimization
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2 text-success"></i>System Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Database Health</span>
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Excellent
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Optimization Engine</span>
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Ready
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Data Completeness</span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                <div class="progress-bar bg-info" style="width: {{ data_completeness|default(85) }}%"></div>
                            </div>
                            <span class="badge bg-info">{{ data_completeness|default(85) }}%</span>
                        </div>
                    </div>
                    
                    {% if system_alerts %}
                        <div class="alert alert-warning py-2 mb-3">
                            <small>
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {{ system_alerts|length }} system alert(s) need attention
                            </small>
                        </div>
                    {% endif %}
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="fs-6 fw-bold text-primary">{{ avg_lesson_hours|default(3.2) }}</div>
                                <small class="text-muted">Avg Hours/Lesson</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="fs-6 fw-bold text-success">{{ room_utilization|default(78) }}%</div>
                                <small class="text-muted">Room Utilization</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="fs-6 fw-bold text-info">{{ instructor_workload|default(24) }}h</div>
                                <small class="text-muted">Avg Workload</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Activity -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2 text-primary"></i>Recent Activity
                    </h5>
                    <a href="{{ url_for('optimization.runs') }}" class="btn btn-sm btn-outline-primary">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_optimizations %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Department</th>
                                        <th>Status</th>
                                        <th>Quality</th>
                                        <th>Conflicts</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for run in recent_optimizations %}
                                    <tr>
                                        <td>
                                            <strong>{{ run.department.name }}</strong>
                                            <br><small class="text-muted">Grade {{ run.grade }}</small>
                                        </td>
                                        <td>
                                            {% if run.status == 'completed' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Completed
                                                </span>
                                            {% elif run.status == 'running' %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>Running
                                                </span>
                                            {% elif run.status == 'error' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times me-1"></i>Error
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ run.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if run.results and run.results.get('optimization_summary') %}
                                                <span class="badge bg-{% if run.results.optimization_summary.quality_grade in ['A', 'B'] %}success{% elif run.results.optimization_summary.quality_grade == 'C' %}warning{% else %}danger{% endif %}">
                                                    {{ run.results.optimization_summary.quality_grade }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if run.conflicts_count == 0 %}
                                                <span class="text-success">
                                                    <i class="fas fa-check-circle me-1"></i>None
                                                </span>
                                            {% elif run.conflicts_count %}
                                                <span class="text-warning">{{ run.conflicts_count }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ run.completed_at.strftime('%m/%d %H:%M') if run.completed_at else run.created_at.strftime('%m/%d %H:%M') }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if run.status == 'completed' %}
                                                    <a href="{{ url_for('results.view', run_id=run.id) }}" 
                                                       class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                {% elif run.status == 'running' %}
                                                    <a href="{{ url_for('optimization.progress', session_id=run.session_id) }}" 
                                                       class="btn btn-outline-info btn-sm">
                                                        <i class="fas fa-chart-line"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">No optimization runs yet</h6>
                            <p class="text-muted mb-3">Start your first optimization to see activity here</p>
                            <a href="{{ url_for('optimization.configure') }}" class="btn btn-success">
                                <i class="fas fa-rocket me-2"></i>Start First Optimization
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Stats & Tips -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>Tips & Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small">Setup Progress</span>
                            <span class="badge bg-primary">{{ setup_progress|default(75) }}%</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar" style="width: {{ setup_progress|default(75) }}%"></div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info py-2 mb-3">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Tip:</strong> Ensure all instructors have availability schedules set for better optimization results.
                        </small>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">Departments with lessons</span>
                                <span class="badge bg-success">{{ departments_with_lessons|default(4) }}</span>
                            </div>
                        </div>
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">Instructors assigned</span>
                                <span class="badge bg-info">{{ instructors_assigned|default(28) }}</span>
                            </div>
                        </div>
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">Lab classrooms</span>
                                <span class="badge bg-warning">{{ lab_classrooms|default(12) }}</span>
                            </div>
                        </div>
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">Average class size</span>
                                <span class="badge bg-secondary">{{ avg_class_size|default(35) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('optimization.index') }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-chart-bar me-2"></i>View Analytics
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Management Overview -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2 text-primary"></i>Data Management Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <i class="fas fa-building fa-2x text-primary mb-2"></i>
                                <h4>{{ departments_count|default(0) }}</h4>
                                <p class="mb-2">Departments</p>
                                <a href="{{ url_for('data_entry.departments') }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <i class="fas fa-book fa-2x text-success mb-2"></i>
                                <h4>{{ lessons_count|default(0) }}</h4>
                                <p class="mb-2">Lessons</p>
                                <a href="{{ url_for('data_entry.lessons') }}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <i class="fas fa-chalkboard-teacher fa-2x text-info mb-2"></i>
                                <h4>{{ instructors_count|default(0) }}</h4>
                                <p class="mb-2">Instructors</p>
                                <a href="{{ url_for('data_entry.instructors') }}" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <i class="fas fa-door-open fa-2x text-warning mb-2"></i>
                                <h4>{{ classrooms_count|default(0) }}</h4>
                                <p class="mb-2">Classrooms</p>
                                <a href="{{ url_for('data_entry.classrooms') }}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard real-time updates
function updateDashboard() {
    fetch('/api/dashboard-stats')
        .then(response => response.json())
        .then(data => {
            // Update counters with animation
            Object.keys(data).forEach(key => {
                const element = document.querySelector(`[data-stat="${key}"]`);
                if (element) {
                    const currentValue = parseInt(element.textContent);
                    const newValue = data[key];
                    if (currentValue !== newValue) {
                        animateCounter(element, currentValue, newValue);
                    }
                }
            });
        })
        .catch(error => console.error('Error updating dashboard:', error));
}

function animateCounter(element, start, end) {
    const duration = 1000;
    const increment = (end - start) / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        element.textContent = Math.round(current);
    }, 16);
}

// Auto-refresh dashboard every 30 seconds
setInterval(updateDashboard, 30000);

// Add tooltip to system alerts
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    alerts.forEach(alert => {
        new bootstrap.Tooltip(alert);
    });
});

// Card hover effects
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card-stat');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});
</script>
{% endblock %}